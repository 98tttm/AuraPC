<div class="builder-container">
    <aside class="sidebar">
        <ul class="nav-menu">
            <li class="nav-item nav-item--clickable" [class.active]="isOverview()" (click)="goOverview()">Aura Builder
            </li>
            @for (step of steps; track step) {
            <li class="nav-item" [class.nav-item--clickable]="isBuilderMode() && isStepAccessible(step)"
                [class.nav-item--locked]="isBuilderMode() && isStepLocked(step)"
                [class.nav-item--no-click]="!isBuilderMode()" [class.active]="isStepCurrent(step)"
                [class.completed]="isBuilderMode() && isStepCompleted(step) && !isStepCurrent(step)"
                (click)="isBuilderMode() && isStepAccessible(step) && goToStep(step)">
                {{ getStepLabel(step) }}
            </li>
            }
            @if (isBuilderMode()) {
            <li class="nav-item nav-item--clickable" [class.active]="currentStep() === 'OVERVIEW'"
                (click)="goToStep('OVERVIEW')">Tổng quan</li>
            @if (visualImageUrl()) {
            <li class="nav-item nav-item--clickable nav-item--auravisual"
                [class.active]="currentStep() === 'AURAVISUAL'" (click)="goToStep('AURAVISUAL')">
                <video class="nav-item-auravisual-bg" autoplay muted loop playsinline>
                    <source src="assets/video/universe.mp4" type="video/mp4" />
                </video>
                <span class="nav-item-auravisual-label">AuraVisual</span>
            </li>
            }
            }
        </ul>

        <div class="sidebar-footer">
            @if (isBuilderMode()) {
            <button class="sidebar-btn reset" (click)="startOver()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12" />
                </svg>
                Bắt đầu lại
            </button>
            } @else {
            <button class="sidebar-btn reset" (click)="startOver()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12" />
                </svg>
                Bắt đầu lại
            </button>
            }
        </div>
    </aside>

    <main class="main-content" [class.main-content--builder]="isBuilderMode()">
        @if (!isBuilderMode()) {
        <div class="bg-pattern"></div>
        <div class="content-wrapper--welcome">
            <h1 class="page-title">AURA BUILDER</h1>
            <p class="tagline tagline--primary">Nhận gợi ý tương thích</p>
            <p class="tagline tagline--secondary">Chọn linh kiện AuraPC lý tưởng cho bạn</p>
            <div class="hero-section">
                <div class="hero-image-wrap">
                    <img src="assets/aura-builder/welcome.webp" alt="PC Builder" class="hero-image">
                    <button class="cta-button" (click)="planYourBuild()">LÊN KẾ HOẠCH BUILD</button>
                </div>
            </div>
        </div>
        } @else {
        <div class="builder-main" [class.builder-main--overview]="currentStep() === 'OVERVIEW'"
            [class.builder-main--visual]="currentStep() === 'AURAVISUAL'">
            @if (currentStep() === 'OVERVIEW') {
            <div class="overview-corsair">
                <div class="overview-corsair__header">
                    <span class="overview-corsair__header-title">TỔNG QUAN</span>
                    @if (builderShareId()) {
                    <button type="button" class="overview-corsair__share" (click)="copyShareLink()">Chia sẻ
                        link</button>
                    }
                </div>

                <div class="overview-corsair__body">
                    <div class="overview-corsair__col overview-corsair__col--left">
                        <h3 class="overview-corsair__col-title">LỰA CHỌN LINH KIỆN</h3>
                        @for (item of overviewCoreComponents(); track item.step) {
                        <div class="overview-corsair__core-item">
                            <span class="overview-corsair__core-label">{{ getStepLabel(item.step) }}</span>
                            <p class="overview-corsair__core-name">{{ item.data?.name }}</p>
                            <a class="overview-corsair__link" (click)="goToStep(item.step)">Sửa</a>
                        </div>
                        }
                    </div>

                    <div class="overview-corsair__col overview-corsair__col--center">
                        <h3 class="overview-corsair__col-title">XEM TRƯỚC ĐƠN HÀNG</h3>
                        @for (item of overviewOrderPreview(); track item.step) {
                        <div class="overview-corsair__order-item">
                            <img [src]="getComponentImage(item.data)" [alt]="item.data?.name"
                                class="overview-corsair__order-img" />
                            <div class="overview-corsair__order-info">
                                <span class="overview-corsair__order-label">{{ getStepLabel(item.step) }}</span>
                                <p class="overview-corsair__order-name">{{ item.data?.name }}</p>
                                <a class="overview-corsair__link" (click)="goToStep(item.step)">Sửa</a>
                            </div>
                            <span class="overview-corsair__order-price">{{ formatPriceNumber(item.data?.price ?? 0)
                                }}</span>
                        </div>
                        }
                    </div>

                    <div class="overview-corsair__col overview-corsair__col--right">
                        <h3 class="overview-corsair__col-title">CAM KẾT CỦA CHÚNG TÔI</h3>
                        <ul class="overview-corsair__guarantee-list">
                            <li>Đảm bảo tương thích linh kiện</li>
                            <li>Giao hàng nhanh</li>
                            <li>Đổi trả dễ dàng</li>
                            <li>Bảo hành chính hãng</li>
                            <li>Hỗ trợ kỹ thuật tận tâm</li>
                        </ul>
                    </div>
                </div>

                <div class="overview-corsair__footer">
                    <div class="overview-corsair__total-row">
                        <span class="overview-corsair__total-label">TỔNG CỘNG</span>
                        <span class="overview-corsair__total-value">{{ formatPriceNumber(overviewTotal()) }}</span>
                    </div>
                    <div class="overview-corsair__actions">
                        <button type="button" class="overview-corsair__btn overview-corsair__btn--outline"
                            (click)="onSaveConfiguration()">Lưu cấu hình</button>
                        <button type="button" class="overview-corsair__btn overview-corsair__btn--visual"
                            (click)="triggerAuraVisual()">AuraVisual</button>
                        <button type="button" class="overview-corsair__btn overview-corsair__btn--primary"
                            (click)="addAllToCart()">Thêm vào giỏ</button>
                    </div>
                </div>
            </div>
            } @else if (currentStep() === 'AURAVISUAL') {
            <div class="av-workflow">
                <video class="av-bg-video" autoplay loop muted playsinline preload="auto">
                    <source src="assets/video/deploy.mp4" type="video/mp4" />
                </video>
                <div class="av-overlay"></div>

                <div class="av-content">
                    <div class="av-header">
                        <h2>AURAVISUAL WORKFLOW</h2>
                        <p>Hệ thống AI xử lý siêu phẩm của bạn</p>
                    </div>

                    <div class="av-grid">
                        <!-- Column 1: Input -->
                        <div class="av-col av-input">
                            <h3 class="av-col-title"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="2">
                                    <path
                                        d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z">
                                    </path>
                                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                                    <line x1="12" y1="22.08" x2="12" y2="12"></line>
                                </svg> LINH KIỆN</h3>
                            <div class="av-input-list">
                                @for (item of overviewComponents(); track item.step) {
                                <div class="av-input-item">
                                    <div class="av-input-icon">
                                        <img [src]="getComponentImage(item.data)" [alt]="item.data?.name" />
                                    </div>
                                    <div class="av-input-info">
                                        <span class="av-badge">{{ getStepLabel(item.step) }}</span>
                                        <p class="av-name">{{ item.data?.name }}</p>
                                    </div>
                                </div>
                                }
                            </div>
                        </div>

                        <div class="av-arrow">
                            <span class="av-flow-line"></span>
                            <span class="av-flow-head"></span>
                        </div>

                        <!-- Column 2: Processing -->
                        <div class="av-col av-processing">
                            <h3 class="av-col-title"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="3"></circle>
                                    <path
                                        d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                                    </path>
                                </svg> Xử lý hình ảnh</h3>
                            <div class="av-process-nodes">
                                <div class="av-node">
                                    <div class="av-node-icon"><img src="assets/LOGO/LogoBlack.png" alt="AuraPC"
                                            style="width:24px;" /></div>
                                    <div class="av-node-text">
                                        <h4>Webhook Sync</h4>
                                        <p>Đồng bộ Payload Data</p>
                                    </div>
                                </div>
                                <div class="av-node-line"></div>
                                <div class="av-node">
                                    <div class="av-node-icon ai-glow"><svg width="24" height="24" viewBox="0 0 24 24"
                                            fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <path d="M12 16v-4"></path>
                                            <path d="M12 8h.01"></path>
                                        </svg></div>
                                    <div class="av-node-text">
                                        <h4>Replicate Model</h4>
                                        <p>Generative Engine</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="av-arrow">
                            <span class="av-flow-line"></span>
                            <span class="av-flow-head"></span>
                        </div>

                        <!-- Column 3: Output -->
                        <div class="av-col av-output">
                            <h3 class="av-col-title"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                    <polyline points="21 15 16 10 5 21"></polyline>
                                </svg> Góc PC của bạn</h3>
                            <div class="av-result-card">
                                @if (visualLoading()) {
                                <div class="av-loading-state">
                                    <div class="av-spinner"></div>
                                    <p class="av-status-title">A.I. đang rendering...</p>
                                    <p class="av-status-desc">Hệ thống đang xử lý prompt và xuất hình ảnh</p>
                                </div>
                                } @else if (visualError()) {
                                <div class="av-error-state">
                                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#e53935"
                                        stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <line x1="12" y1="8" x2="12" y2="12"></line>
                                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                    </svg>
                                    <p class="av-status-title">Lỗi tạo ảnh</p>
                                    <p class="av-status-desc">{{ visualError() }}</p>
                                </div>
                                } @else if (visualImageUrl()) {
                                <img [src]="visualImageUrl()" alt="AuraVisual Rendering" class="av-result-img" />
                                <div class="av-actions">
                                    <a [href]="visualImageUrl()" download="AuraVisual_PC.png" class="av-btn-primary">Tải Góc Setup</a>
                                </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            } @else {
            <div class="builder-header">
                <h2 class="builder-step-title">{{ getStepTitle(currentStep()) }}</h2>
            </div>

            <div class="builder-toolbar">
                <div class="builder-search">
                    <input type="search" class="builder-search__input"
                        [placeholder]="'Tìm ' + total() + ' ' + getStepTitle(currentStep()).toLowerCase()"
                        [ngModel]="searchTerm()" (ngModelChange)="onSearch($event)" />
                    <svg class="builder-search__icon" viewBox="0 0 24 24" fill="none">
                        <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2" />
                        <path d="M16 16l4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    </svg>
                </div>
                <div class="builder-filters">
                    <span class="builder-filter-label">Lọc theo:</span>
                    <div class="builder-filter-group">
                        <select class="builder-filter__select" [ngModel]="selectedBrand() ?? ''"
                            (ngModelChange)="onBrandChange($event)" [title]="'Hãng sản xuất'">
                            <option value="">Hãng sản xuất</option>
                            @for (b of brands(); track b) {
                            <option [value]="b">{{ b }}</option>
                            }
                        </select>
                    </div>
                    @for (f of stepFilters(); track f.param) {
                    <div class="builder-filter-group">
                        <select class="builder-filter__select" [ngModel]="(getSelectedFilter(f.param) ?? '')"
                            (ngModelChange)="onFilterChange(f.param, $event)" [title]="f.label">
                            <option value="">{{ getFilterPlaceholder(f.param) }}</option>
                            @for (opt of getFilterOptionsFor(f.param); track opt) {
                            <option [value]="opt">{{ opt }}</option>
                            }
                        </select>
                    </div>
                    }
                    @if (hasFilters()) {
                    <button type="button" class="builder-filter__clear" (click)="clearFilters()">Xóa bộ lọc</button>
                    }
                </div>
            </div>

            <div class="builder-body">
                <div class="builder-grid-wrap">
                    @if (loading()) {
                    <div class="builder-loading">
                        <img src="assets/LOGO/LogoBlack.png" alt="AuraPC" class="builder-loading__logo" />
                        <div class="builder-loading__spinner"></div>
                        <p>Đang tải sản phẩm...</p>
                    </div>
                    } @else if (products().length === 0) {
                    <div class="builder-empty">
                        <p>Không tìm thấy sản phẩm phù hợp.</p>
                    </div>
                    } @else {
                    <div class="builder-grid">
                        @for (p of products(); track p._id || p.slug) {
                        <div class="builder-card" [class.builder-card--selected]="selectedProduct()?._id === p._id"
                            (click)="selectProduct(p)">
                            <div class="builder-card__img-wrap">
                                <img [src]="getProductImage(p)" [alt]="p.name" class="builder-card__img" />
                            </div>
                            <h3 class="builder-card__name">{{ p.name }}</h3>
                            <p class="builder-card__price">{{ formatPrice(p) }}</p>
                        </div>
                        }
                    </div>
                    }
                </div>

                <aside class="builder-detail-panel">
                    <div class="builder-detail-panel__header">
                        <h3>CHỌN {{ getStepTitle(currentStep()).toUpperCase() }}</h3>
                    </div>
                    <div class="builder-detail-panel__body">
                        <p class="builder-detail-panel__hint">
                            Chọn {{ getStepTitle(currentStep()).toLowerCase() }} phù hợp để xây dựng cấu hình PC.
                        </p>
                        @if (selectedProduct(); as sp) {
                        <div class="builder-detail-panel__selected">
                            <img [src]="getProductImage(sp)" [alt]="sp.name" class="builder-detail-panel__img" />
                            <h4>{{ sp.name }}</h4>
                            <p class="builder-detail-panel__price">{{ formatPrice(sp) }}</p>
                            @if (getSpecLines(sp).length) {
                            <div class="builder-specs">
                                <h5>THÔNG SỐ</h5>
                                @for (line of getSpecLines(sp); track line.label) {
                                <p><strong>{{ line.label }}:</strong> {{ line.value }}</p>
                                }
                            </div>
                            }
                        </div>
                        } @else {
                        <div class="builder-detail-panel__placeholder">
                            <p>Nhấn vào sản phẩm để xem chi tiết</p>
                        </div>
                        }
                    </div>
                </aside>
            </div>

            <div class="builder-footer">
                <div class="builder-footer__inner">
                    @if (!canGoNext() && !nextLoading()) {
                    <span class="builder-footer__hint">Chọn một sản phẩm để tiếp tục</span>
                    }
                    <button type="button" class="builder-next-btn" [disabled]="!canGoNext() || nextLoading()"
                        [title]="canGoNext() ? 'Tiếp tục bước tiếp theo' : 'Chọn một sản phẩm để tiếp tục'"
                        (click)="goNext()">
                        {{ nextLoading() ? 'Đang lưu...' : 'TIẾP THEO' }}
                    </button>
                </div>
            </div>
            }
        </div>
        }
    </main>
</div>

@if (showSaveModal()) {
<div class="save-modal-overlay" (click)="closeSaveModal()">
    <div class="save-modal" (click)="$event.stopPropagation()">
        <h3 class="save-modal__title">Nhận thông tin cấu hình qua Email</h3>
        <p class="save-modal__desc">Nhập email để nhận file PDF thông tin cấu hình PC của bạn.</p>
        <div class="save-modal__form">
            <input type="email" class="save-modal__input" placeholder="Email nhận thông tin cấu hình"
                [ngModel]="saveModalEmail()" (ngModelChange)="saveModalEmail.set($event)"
                (keydown.enter)="sendConfigEmail()" />
            @if (saveModalError()) {
            <p class="save-modal__error">{{ saveModalError() }}</p>
            }
        </div>
        <div class="save-modal__actions">
            <button type="button" class="save-modal__btn save-modal__btn--outline" (click)="closeSaveModal()">
                Hủy
            </button>
            <button type="button" class="save-modal__btn save-modal__btn--primary" [disabled]="saveModalLoading()"
                (click)="sendConfigEmail()">
                {{ saveModalLoading() ? 'Đang gửi...' : 'Gửi cấu hình' }}
            </button>
        </div>
    </div>
</div>
}

@if (toastMessage()) {
<div class="toast">{{ toastMessage() }}</div>
}