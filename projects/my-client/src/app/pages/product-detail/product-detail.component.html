<div class="pd-page">
  <div class="pd-container">
    @if (loading()) {
    <div class="pd-loading">
      <div class="pd-spinner"></div>
      <p>ƒêang t·∫£i d·ªØ li·ªáu s·∫£n ph·∫©m...</p>
    </div>
    } @else if (error() || !product()) {
    <div class="pd-error">
      <p>Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m ho·∫∑c c√≥ l·ªói x·∫£y ra.</p>
      <a routerLink="/san-pham" class="pd-back">‚Üê Quay l·∫°i danh s√°ch</a>
    </div>
    } @else {
    @let p = product()!;
    <nav class="pd-breadcrumb">
      <a routerLink="/">Trang ch·ªß</a>
      @if (p.category) {
      <span class="pd-sep">/</span>
      <a [routerLink]="['/san-pham']" [queryParams]="{category: p.category.slug || p.category.category_id}">{{
        p.category.name }}</a>
      } @else {
      <span class="pd-sep">/</span>
      <a routerLink="/san-pham">S·∫£n ph·∫©m</a>
      }
      <span class="pd-sep">/</span>
      <span class="pd-crumb-current">{{ p.name }}</span>
    </nav>

    <!-- Top Section -->
    <div class="pd-top">
      <!-- Left: Gallery -->
      <div class="pd-gallery-section">
        <div class="pd-main-img-wrap">
          <img [src]="currentImage()" class="pd-main-img" [alt]="p.name" />
          @if (imageList(p).length > 1) {
          <button class="pd-img-nav prev" (click)="prevImage()">‚ùÆ</button>
          <button class="pd-img-nav next" (click)="nextImage()">‚ùØ</button>
          }
        </div>
        <div class="pd-thumbs">
          @for (img of imageList(p); track img) {
          <button class="pd-thumb" [class.active]="currentImage() === img" (click)="selectImage(img)">
            <img [src]="img" [alt]="p.name" />
          </button>
          }
        </div>
      </div>

      <!-- Right: Info -->
      <div class="pd-info-section">
        <h1 class="pd-title">{{ p.name }}</h1>

        <div class="pd-meta">
          <span class="pd-meta-item">Th∆∞∆°ng hi·ªáu: <strong>{{ brandName(p) }}</strong></span>
          <span class="pd-meta-sep">|</span>
          <span class="pd-meta-item">T√¨nh tr·∫°ng: <span class="pd-stock in-stock">C√≤n h√†ng</span></span>
          <span class="pd-meta-sep">|</span>
          <span class="pd-meta-item">SKU: {{ sku(p) }}</span>
        </div>

        <div class="pd-price-box">
          <div class="pd-price-row">
            <span class="pd-label">Gi√° b√°n:</span>
            <span class="pd-price-current">{{ priceLabel(p) }}</span>
            @if (hasSale(p)) {
            <span class="pd-price-old">{{ oldPriceLabel(p) }}</span>
            <span class="pd-discount">-{{ salePercent(p) }}%</span>
            }
          </div>
          <div class="pd-vat-note">(ƒê√£ bao g·ªìm VAT)</div>
        </div>

        @if (shortSpecs(p).length) {
        <div class="pd-short-features">
          <div class="pd-feature-title">ƒê·∫∑c ƒëi·ªÉm n·ªïi b·∫≠t:</div>
          <ul class="pd-feature-list">
            @for (s of shortSpecs(p); track s.label) {
            <li>
              <span class="pd-check-icon">‚úî</span>
              <strong>{{ s.label }}:</strong> {{ s.value }}
            </li>
            }
          </ul>
        </div>
        }

        <div class="pd-promo-box">
          <div class="pd-promo-header">üéÅ KHUY·∫æN M√ÉI ƒê·∫∂C BI·ªÜT</div>
          <div class="pd-promo-content">
            <ul>
              <li>H·ªó tr·ª£ tr·∫£ g√≥p 0% l√£i su·∫•t qua th·∫ª t√≠n d·ª•ng.</li>
              <li>T·∫∑ng Balo Gaming cao c·∫•p (khi mua Laptop).</li>
              <li>Mi·ªÖn ph√≠ v·ªá sinh m√°y tr·ªçn ƒë·ªùi.</li>
              <li>Gi·∫£m gi√° 5% khi mua k√®m Gear.</li>
            </ul>
          </div>
        </div>

        <div class="pd-actions">
          <button class="pd-btn pd-btn-buy">
            <span class="pd-btn-title">MUA NGAY</span>
            <span class="pd-btn-desc">Giao h√†ng t·∫≠n n∆°i ho·∫∑c nh·∫≠n t·∫°i c·ª≠a h√†ng</span>
          </button>
          <button class="pd-btn pd-btn-cart">
            <span class="pd-btn-title">TH√äM V√ÄO GI·ªé</span>
            <span class="pd-btn-desc">Th√™m v√†o gi·ªè ƒë·ªÉ ch·ªçn ti·∫øp</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Bottom Section -->
    <div class="pd-content-layout">
      <!-- Main Content (Left) -->
      <div class="pd-main-content">
        <div class="pd-content-block">
          <h2 class="pd-block-title">ƒê·∫∑c ƒëi·ªÉm n·ªïi b·∫≠t</h2>
          @if (descriptionSafe(p); as safeHtml) {
          <div class="pd-desc-container" [class.expanded]="showFullDesc()">
            <div class="pd-html-content" [innerHTML]="safeHtml"></div>
            @if (!showFullDesc()) {
            <div class="pd-desc-mask"></div>
            }
          </div>
          <div class="pd-desc-actions">
            <button class="pd-view-more-btn" (click)="toggleDesc()">
              {{ showFullDesc() ? 'Thu g·ªçn n·ªôi dung' : 'Xem th√™m ƒë√°nh gi√°' }}
            </button>
          </div>
          } @else {
          <div class="pd-no-content">
            <p>Th√¥ng tin chi ti·∫øt ƒëang ƒë∆∞·ª£c c·∫≠p nh·∫≠t.</p>
            @if (p.shortDescription) {
            <p>{{ p.shortDescription }}</p>
            }
          </div>
          }
        </div>
      </div>

      <!-- Sidebar Specs (Right) -->
      <aside class="pd-sidebar-specs">
        <div class="pd-specs-box">
          <h2 class="pd-specs-header">Th√¥ng s·ªë k·ªπ thu·∫≠t</h2>
          <table class="pd-specs-table">
            <tbody>
              @for (row of visibleSpecEntries; track row.key; let odd = $odd) {
              <tr [class.odd]="odd">
                <th>{{ row.key }}</th>
                <td>{{ row.value }}</td>
              </tr>
              }
            </tbody>
          </table>
          <div class="pd-specs-actions">
            <button class="pd-view-full-specs" (click)="toggleSpecsModal()">
              ‚öô Chi ti·∫øt th√¥ng s·ªë k·ªπ thu·∫≠t
            </button>
          </div>
        </div>
      </aside>
    </div>

    <!-- Specs Modal -->
    @if (showSpecsModal()) {
    <div class="pd-modal-overlay" (click)="toggleSpecsModal()">
      <div class="pd-modal-content" (click)="$event.stopPropagation()">
        <div class="pd-modal-header">
          <h3>Th√¥ng s·ªë k·ªπ thu·∫≠t chi ti·∫øt</h3>
          <button class="pd-modal-close" (click)="toggleSpecsModal()">√ó</button>
        </div>
        <div class="pd-modal-body">
          <h4 class="pd-modal-prod-name">{{ p.name }}</h4>
          <table class="pd-specs-table pd-table-full">
            <tbody>
              @for (row of specEntries(p); track row.key; let odd = $odd) {
              <tr [class.odd]="odd">
                <th>{{ row.key }}</th>
                <td>{{ row.value }}</td>
              </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
    }

    <!-- Related Products -->
    <div class="pd-related">
      <h2 class="pd-section-title">S·∫¢N PH·∫®M LI√äN QUAN</h2>
      <div class="pd-related-grid">
        @for (rp of relatedProducts(); track rp._id) {
        <a class="pd-related-card" [routerLink]="['/san-pham', rp.slug || rp._id]">
          <div class="pd-related-img">
            <img [src]="mainImage(rp)" [alt]="rp.name" />
          </div>
          <h3 class="pd-related-name">{{ rp.name }}</h3>
          <p class="pd-related-price">{{ priceLabel(rp) }}</p>
        </a>
        }
      </div>
    </div>

    <!-- Reviews Section -->
    <div class="pd-reviews-section">
      <h2 class="pd-section-title">ƒê√°nh gi√° s·∫£n ph·∫©m <span class="review-count-badge">{{ mockReviews.length }} ƒë√°nh
          gi√°</span></h2>

      <div class="pd-review-summary">
        <div class="review-score">
          <span class="score-number">{{ avgRating.toFixed(1) }}</span>
          <div class="score-stars">
            @for (star of [1,2,3,4,5]; track star) {
            <span class="star" [class.filled]="star <= avgRating">‚òÖ</span>
            }
          </div>
        </div>
        <div class="review-bars">
          @for (bar of ratingBars; track bar.star) {
          <div class="bar-row">
            <span class="bar-label">{{ bar.star }} ‚òÖ</span>
            <div class="bar-track">
              <div class="bar-fill" [style.width.%]="bar.percent"></div>
            </div>
            <span class="bar-count">{{ bar.count }}</span>
          </div>
          }
        </div>
      </div>

      <!-- Review Filter -->
      <div class="review-filters">
        <button class="review-filter-btn" [class.active]="reviewFilter === 'all'" (click)="reviewFilter = 'all'">T·∫•t
          c·∫£</button>
        <button class="review-filter-btn" [class.active]="reviewFilter === 'newest'"
          (click)="reviewFilter = 'newest'">M·ªõi nh·∫•t</button>
        <button class="review-filter-btn" [class.active]="reviewFilter === 'photo'" (click)="reviewFilter = 'photo'">C√≥
          ·∫£nh</button>
      </div>

      <!-- Review List -->
      <div class="review-list">
        @for (review of mockReviews; track review.id) {
        <div class="review-card">
          <div class="review-header">
            <div class="review-avatar">{{ review.name.charAt(0) }}</div>
            <div class="review-meta">
              <span class="review-name">{{ review.name }}</span>
              <span class="review-date">{{ review.date }}</span>
            </div>
            <div class="review-stars-small">
              @for (star of [1,2,3,4,5]; track star) {
              <span class="star-sm" [class.filled]="star <= review.rating">‚òÖ</span>
              }
            </div>
          </div>
          <p class="review-text">{{ review.text }}</p>
        </div>
        }
      </div>
    </div>

    <!-- Q&A Section -->
    <div class="pd-qa-section">
      <h2 class="pd-section-title">ƒê√°nh gi√° h·ªèi ƒë√°p <span class="review-count-badge">{{ mockQA.length }} b√¨nh
          lu·∫≠n</span></h2>

      <div class="review-filters">
        <button class="review-filter-btn" [class.active]="qaFilter === 'all'" (click)="qaFilter = 'all'">T·∫•t c·∫£</button>
        <button class="review-filter-btn" [class.active]="qaFilter === 'newest'" (click)="qaFilter = 'newest'">M·ªõi
          nh·∫•t</button>
        <button class="review-filter-btn" [class.active]="qaFilter === 'photo'" (click)="qaFilter = 'photo'">C√≥
          ·∫£nh</button>
      </div>

      <div class="qa-list">
        @for (qa of mockQA; track qa.id) {
        <div class="qa-card">
          <div class="qa-question">
            <div class="qa-avatar">{{ qa.name.charAt(0) }}</div>
            <div class="qa-content">
              <div class="qa-user-info">
                <span class="qa-name">{{ qa.name }}</span>
                <span class="qa-date">{{ qa.date }}</span>
              </div>
              <p class="qa-text">{{ qa.question }}</p>
            </div>
          </div>
          @if (qa.reply) {
          <div class="qa-reply">
            <div class="qa-reply-indicator">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 10h10a5 5 0 0 1 0 10h-2" />
                <polyline points="7 14 3 10 7 6" />
              </svg>
            </div>
            <div class="qa-reply-content">
              <span class="qa-reply-author">Admin - Aura PC</span>
              <p class="qa-reply-text">{{ qa.reply }}</p>
            </div>
          </div>
          }
        </div>
        }
      </div>
    </div>

    <!-- Recently Viewed -->
    <div class="pd-related">
      <h2 class="pd-section-title">S·∫¢N PH·∫®M V·ª™A XEM</h2>
      <div class="pd-related-grid">
        @for (rp of relatedProducts(); track rp._id) {
        <a class="pd-related-card" [routerLink]="['/san-pham', rp.slug || rp._id]">
          <div class="pd-related-img">
            <img [src]="mainImage(rp)" [alt]="rp.name" />
          </div>
          <h3 class="pd-related-name">{{ rp.name }}</h3>
          <p class="pd-related-price">{{ priceLabel(rp) }}</p>
        </a>
        }
      </div>
    </div>
    }
  </div>
</div>