<section class="checkout-page">
    <div class="checkout-container">
        <!-- Back -->
        <a routerLink="/cart" class="checkout-back">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
            Quay l·∫°i gi·ªè h√†ng
        </a>

        @if (cartItems().length === 0) {
        <div class="checkout-empty">
            <p>Gi·ªè h√†ng tr·ªëng. <a routerLink="/san-pham">Ti·∫øp t·ª•c mua s·∫Øm</a></p>
        </div>
        } @else {
        <div class="checkout-layout">
            <!-- ===== LEFT COLUMN ===== -->
            <div class="checkout-left">

                <!-- Product Summary -->
                <div class="checkout-card">
                    <h2 class="checkout-section-title">Danh s√°ch s·∫£n ph·∫©m</h2>
                    <div class="checkout-shipping-banner">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="#FF6D2D" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="1" y="3" width="15" height="13"></rect>
                            <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
                            <circle cx="5.5" cy="18.5" r="2.5"></circle>
                            <circle cx="18.5" cy="18.5" r="2.5"></circle>
                        </svg>
                        <span>Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn ƒë·ªëi v·ªõi ƒë∆°n h√†ng tr√™n 500.000‚Ç´</span>
                    </div>
                    @for (item of cartItems(); track item.product._id) {
                    <div class="checkout-product">
                        <img class="checkout-product__img" [src]="getImage(item.product)" [alt]="item.product.name" />
                        <div class="checkout-product__info">
                            <h3 class="checkout-product__name">{{ item.product.name }}</h3>
                            <span class="checkout-product__price">{{ priceLabel(item.product) }}</span>
                        </div>
                        <span class="checkout-product__qty">x{{ item.qty }}</span>
                    </div>
                    }
                </div>

                <!-- Buyer Info -->
                <div class="checkout-card">
                    <h3 class="checkout-section-title">Th√¥ng tin ng∆∞·ªùi ƒë·∫∑t</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">H·ªç v√† t√™n <span class="required">*</span></label>
                            <input type="text" [(ngModel)]="fullName" placeholder="Nh·∫≠p h·ªç v√† t√™n" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">S·ªë ƒëi·ªán tho·∫°i <span class="required">*</span></label>
                            <input type="tel" [(ngModel)]="phone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email (kh√¥ng b·∫Øt bu·ªôc)</label>
                        <input type="email" [(ngModel)]="email" placeholder="Nh·∫≠p email" />
                    </div>
                </div>

                <!-- Receiver Info -->
                <div class="checkout-card">
                    <h3 class="checkout-section-title">Th√¥ng tin nh·∫≠n h√†ng</h3>
                    @if (isLoggedIn() && addressService.addresses().length > 0) {
                    <div class="form-group">
                        <label class="form-label">Ch·ªçn ƒë·ªãa ch·ªâ ƒë√£ l∆∞u</label>
                        <select [(ngModel)]="selectedAddressId" (ngModelChange)="onAddressSelect()">
                            @for (addr of addressService.addresses(); track addr._id) {
                            <option [value]="addr._id">{{ addr.label }} ‚Äî {{ addr.fullName }}, {{ addr.phone }}</option>
                            }
                            <option value="">Nh·∫≠p ƒë·ªãa ch·ªâ m·ªõi</option>
                        </select>
                    </div>
                    }
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">H·ªç v√† t√™n ng∆∞·ªùi nh·∫≠n</label>
                            <input type="text" [(ngModel)]="receiverName"
                                placeholder="M·∫∑c ƒë·ªãnh theo th√¥ng tin ng∆∞·ªùi ƒë·∫∑t" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">S·ªë ƒëi·ªán tho·∫°i ng∆∞·ªùi nh·∫≠n</label>
                            <input type="tel" [(ngModel)]="receiverPhone" placeholder="M·∫∑c ƒë·ªãnh theo ng∆∞·ªùi ƒë·∫∑t" />
                        </div>
                    </div>
                </div>

                <!-- Address -->
                <div class="checkout-card">
                    <h3 class="checkout-section-title">ƒê·ªãa ch·ªâ nh·∫≠n h√†ng</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">T·ªânh / Th√†nh ph·ªë</label>
                            <select [(ngModel)]="city">
                                <option value="">Ch·ªçn T·ªânh / Th√†nh ph·ªë</option>
                                <option value="hcm">TP. H·ªì Ch√≠ Minh</option>
                                <option value="hn">H√† N·ªôi</option>
                                <option value="dn">ƒê√† N·∫µng</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Qu·∫≠n / Huy·ªán</label>
                            <select [(ngModel)]="district">
                                <option value="">Ch·ªçn Qu·∫≠n / Huy·ªán</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ph∆∞·ªùng / X√£</label>
                        <select [(ngModel)]="ward">
                            <option value="">Ch·ªçn Ph∆∞·ªùng / X√£</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ƒê·ªãa ch·ªâ c·ª• th·ªÉ <span class="required">*</span></label>
                        <input type="text" [(ngModel)]="address" placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng..." />
                    </div>
                </div>

                <!-- Note -->
                <div class="checkout-card">
                    <h3 class="checkout-section-title">Ghi ch√∫</h3>
                    <div class="form-group">
                        <textarea [(ngModel)]="note" placeholder="V√≠ d·ª•: H√£y g·ªçi cho t√¥i 15 ph√∫t tr∆∞·ªõc khi giao"
                            rows="3"></textarea>
                    </div>

                    <div class="invoice-row">
                        <span class="invoice-label">Y√™u c·∫ßu xu·∫•t h√≥a ƒë∆°n ƒëi·ªán t·ª≠</span>
                        <label class="toggle-switch">
                            <input type="checkbox" [(ngModel)]="requestInvoice" />
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- Payment Method -->
                <div class="checkout-card">
                    <h3 class="checkout-section-title">Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n</h3>

                    <label class="payment-option" [class.payment-option--active]="paymentMethod === 'cod'"
                        (click)="paymentMethod = 'cod'">
                        <span class="payment-radio" [class.active]="paymentMethod === 'cod'"></span>
                        <span class="payment-icon">üíµ</span>
                        <span>Thanh to√°n ti·ªÅn m·∫∑t khi nh·∫≠n h√†ng</span>
                    </label>

                    <label class="payment-option" [class.payment-option--active]="paymentMethod === 'qr'"
                        (click)="paymentMethod = 'qr'">
                        <span class="payment-radio" [class.active]="paymentMethod === 'qr'"></span>
                        <span class="payment-icon">üì±</span>
                        <span>Thanh to√°n b·∫±ng chuy·ªÉn kho·∫£n (QR Code)</span>
                    </label>

                    <label class="payment-option" [class.payment-option--active]="paymentMethod === 'momo'"
                        (click)="paymentMethod = 'momo'">
                        <span class="payment-radio" [class.active]="paymentMethod === 'momo'"></span>
                        <img src="assets/figma/515c49e4ff04f92775dfa684cb71aab58d94394c.png" alt="MoMo"
                            class="payment-logo" />
                        <span>Thanh to√°n b·∫±ng v√≠ MoMo</span>
                    </label>

                    <label class="payment-option" [class.payment-option--active]="paymentMethod === 'zalopay'"
                        (click)="paymentMethod = 'zalopay'">
                        <span class="payment-radio" [class.active]="paymentMethod === 'zalopay'"></span>
                        <span class="payment-icon">üí≥</span>
                        <span>Thanh to√°n b·∫±ng v√≠ ZaloPay</span>
                    </label>

                    <label class="payment-option" [class.payment-option--active]="paymentMethod === 'atm'"
                        (click)="paymentMethod = 'atm'">
                        <span class="payment-radio" [class.active]="paymentMethod === 'atm'"></span>
                        <img src="assets/figma/2fa2c0072b5eed1fbba69aed2773ab02e7354df4.png" alt="ATM"
                            class="payment-logo" />
                        <span>Thanh to√°n b·∫±ng th·∫ª ATM n·ªôi ƒë·ªãa, NAPAS</span>
                    </label>
                </div>
            </div>

            <!-- ===== RIGHT COLUMN: Order Summary ===== -->
            <div class="checkout-right">
                <div class="checkout-summary">
                    <!-- Coupon -->
                    <button class="coupon-btn">
                        <span class="coupon-btn__text">√Åp d·ª•ng ∆∞u ƒë√£i ƒë·ªÉ ƒë∆∞·ª£c gi·∫£m gi√°</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </button>

                    <div class="summary-row">
                        <span class="summary-label">T·ªïng ti·ªÅn</span>
                        <span class="summary-val">{{ formatPrice(originalTotal()) }}</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Gi·∫£m gi√° tr·ª±c ti·∫øp</span>
                        <span class="summary-val summary-val--discount">{{ directDiscountLabel() }}</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Ph√≠ v·∫≠n chuy·ªÉn</span>
                        <span class="summary-val summary-val--free">Mi·ªÖn ph√≠</span>
                    </div>

                    <div class="summary-divider"></div>

                    <div class="summary-row summary-row--total">
                        <span class="summary-label">Th√†nh ti·ªÅn</span>
                        <span class="summary-val summary-val--total">{{ formatPrice(selectedTotal()) }}</span>
                    </div>

                    <button class="btn-submit" (click)="submitOrder()" [disabled]="submitting()">
                        {{ submitting() ? 'ƒêang x·ª≠ l√Ω...' : 'Ho√†n t·∫•t' }}
                    </button>

                    <p class="checkout-terms">
                        B·∫±ng vi·ªác ti·∫øn h√†nh ƒë·∫∑t mua h√†ng, b·∫°n ƒë·ªìng √Ω v·ªõi
                        <a href="#">ƒêi·ªÅu kho·∫£n d·ªãch v·ª•</a> c·ªßa AuraPC
                    </p>
                </div>
            </div>
        </div>

        @if (errorMessage()) {
        <div class="checkout-error">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            {{ errorMessage() }}
        </div>
        }
        }
    </div>
</section>