<section class="checkout-page">
    <div class="checkout-container">
        <!-- Back -->
        <a routerLink="/cart" class="checkout-back">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
            Quay l·∫°i gi·ªè h√†ng
        </a>

        @if (cartItems().length > 0) {
        <app-checkout-stepper [step]="2"></app-checkout-stepper>
        }

        @if (cartItems().length === 0) {
        <div class="checkout-empty">
            <p>Gi·ªè h√†ng tr·ªëng. <a routerLink="/san-pham">Ti·∫øp t·ª•c mua s·∫Øm</a></p>
        </div>
        } @else {
        <div class="checkout-layout">
            <!-- ===== LEFT COLUMN ===== -->
            <div class="checkout-left">

                <!-- Product Summary -->
                <div class="checkout-card">
                    <h2 class="checkout-section-title">Danh s√°ch s·∫£n ph·∫©m</h2>
                    <div class="checkout-shipping-banner">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="#FF6D2D" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="1" y="3" width="15" height="13"></rect>
                            <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
                            <circle cx="5.5" cy="18.5" r="2.5"></circle>
                            <circle cx="18.5" cy="18.5" r="2.5"></circle>
                        </svg>
                        <span>Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn ƒë·ªëi v·ªõi ƒë∆°n h√†ng tr√™n 500.000‚Ç´</span>
                    </div>
                    @for (item of cartItems(); track item.product._id) {
                    <div class="checkout-product">
                        <img class="checkout-product__img" [src]="getImage(item.product)" [alt]="item.product.name" />
                        <div class="checkout-product__info">
                            <h3 class="checkout-product__name">{{ item.product.name }}</h3>
                            <span class="checkout-product__price">{{ priceLabel(item.product) }}</span>
                        </div>
                        <span class="checkout-product__qty">x{{ item.qty }}</span>
                    </div>
                    }
                </div>

                <!-- Buyer Info -->
                <div class="checkout-card">
                    <h3 class="checkout-section-title">Th√¥ng tin ng∆∞·ªùi ƒë·∫∑t</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">H·ªç v√† t√™n <span class="required">*</span></label>
                            <input type="text" [(ngModel)]="fullName" placeholder="Nh·∫≠p h·ªç v√† t√™n" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">S·ªë ƒëi·ªán tho·∫°i <span class="required">*</span></label>
                            <input type="tel" [(ngModel)]="phone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email (kh√¥ng b·∫Øt bu·ªôc)</label>
                        <input type="email" [(ngModel)]="email" placeholder="Nh·∫≠p email" />
                    </div>
                </div>

                <!-- Address / Receiver section -->
                <div class="checkout-card">
                    <div class="checkout-card-header">
                        <h3 class="checkout-section-title">ƒê·ªãa ch·ªâ nh·∫≠n h√†ng</h3>
                        @if (isLoggedIn() && addressService.addresses().length > 0) {
                        <button class="btn-change-address" (click)="openAddressModal()">Thay ƒë·ªïi</button>
                        }
                    </div>

                    @if (isLoggedIn()) {
                    <!-- Logged-in User Address Card -->
                    @if (addressService.addresses().length === 0) {
                    <div class="empty-address">
                        <p>B·∫°n ch∆∞a c√≥ ƒë·ªãa ch·ªâ nh·∫≠n h√†ng n√†o.</p>
                        <button class="btn-add-address-empty" (click)="switchToAddMode(); showAddressModal.set(true)">
                            Th√™m ƒë·ªãa ch·ªâ m·ªõi
                        </button>
                    </div>
                    } @else {
                    @if (selectedAddressId) {
                    <div class="selected-address-card">
                        <div class="selected-address__header">
                            <span class="selected-address__name">{{ receiverName }}</span>
                            <span class="selected-address__separator">|</span>
                            <span class="selected-address__phone">{{ receiverPhone }}</span>
                        </div>
                        <div class="selected-address__detail">
                            {{ address }}<br>
                            {{ ward }}, {{ district }}, {{ city }}
                        </div>
                        @if (isAddressDefault(selectedAddressId)) {
                        <span class="badge-default">M·∫∑c ƒë·ªãnh</span>
                        }
                    </div>
                    } @else {
                    <div class="empty-address">
                        <p>Vui l√≤ng ch·ªçn m·ªôt ƒë·ªãa ch·ªâ nh·∫≠n h√†ng.</p>
                        <button class="btn-change-address" (click)="openAddressModal()">Ch·ªçn ƒë·ªãa ch·ªâ</button>
                    </div>
                    }
                    }
                    } @else {
                    <!-- Guest Form -->
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">T·ªânh / Th√†nh ph·ªë</label>
                            <select [(ngModel)]="city">
                                <option value="">Ch·ªçn T·ªânh / Th√†nh ph·ªë</option>
                                <option value="hcm">TP. H·ªì Ch√≠ Minh</option>
                                <option value="hn">H√† N·ªôi</option>
                                <option value="dn">ƒê√† N·∫µng</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Qu·∫≠n / Huy·ªán</label>
                            <select [(ngModel)]="district">
                                <option value="">Ch·ªçn Qu·∫≠n / Huy·ªán</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ph∆∞·ªùng / X√£</label>
                        <select [(ngModel)]="ward">
                            <option value="">Ch·ªçn Ph∆∞·ªùng / X√£</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ƒê·ªãa ch·ªâ c·ª• th·ªÉ <span class="required">*</span></label>
                        <input type="text" [(ngModel)]="address" placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng..." />
                    </div>
                    <div class="form-row" style="margin-top: 16px;">
                        <div class="form-group">
                            <label class="form-label">H·ªç v√† t√™n ng∆∞·ªùi nh·∫≠n</label>
                            <input type="text" [(ngModel)]="receiverName"
                                placeholder="M·∫∑c ƒë·ªãnh theo th√¥ng tin ng∆∞·ªùi ƒë·∫∑t" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">S·ªë ƒëi·ªán tho·∫°i ng∆∞·ªùi nh·∫≠n</label>
                            <input type="tel" [(ngModel)]="receiverPhone" placeholder="M·∫∑c ƒë·ªãnh theo ng∆∞·ªùi ƒë·∫∑t" />
                        </div>
                    </div>
                    }
                </div>

                <!-- Note -->
                <div class="checkout-card">
                    <h3 class="checkout-section-title">Ghi ch√∫</h3>
                    <div class="form-group">
                        <textarea [(ngModel)]="note" placeholder="V√≠ d·ª•: H√£y g·ªçi cho t√¥i 15 ph√∫t tr∆∞·ªõc khi giao"
                            rows="3"></textarea>
                    </div>

                    <div class="invoice-row">
                        <span class="invoice-label">Y√™u c·∫ßu xu·∫•t h√≥a ƒë∆°n ƒëi·ªán t·ª≠</span>
                        <label class="toggle-switch">
                            <input type="checkbox" [(ngModel)]="requestInvoice" />
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    @if (requestInvoice) {
                    <div class="invoice-form" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed #eee;">
                        <div class="form-row" style="margin-bottom: 1rem;">
                            <label class="payment-option" [class.payment-option--active]="invoiceType === 'personal'"
                                (click)="invoiceType = 'personal'">
                                <span class="payment-radio" [class.active]="invoiceType === 'personal'"></span>
                                <span>C√° nh√¢n</span>
                            </label>
                            <label class="payment-option" [class.payment-option--active]="invoiceType === 'company'"
                                (click)="invoiceType = 'company'">
                                <span class="payment-radio" [class.active]="invoiceType === 'company'"></span>
                                <span>C√¥ng ty</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email nh·∫≠n h√≥a ƒë∆°n <span class="required">*</span></label>
                            <input type="email" [(ngModel)]="invoiceEmail" placeholder="Nh·∫≠p email xu·∫•t h√≥a ƒë∆°n" />
                        </div>
                    </div>
                    }
                </div>

                <!-- Payment Method -->
                <div class="checkout-card">
                    <h3 class="checkout-section-title">Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n</h3>

                    <label class="payment-option" [class.payment-option--active]="paymentMethod === 'cod'"
                        (click)="paymentMethod = 'cod'">
                        <span class="payment-radio" [class.active]="paymentMethod === 'cod'"></span>
                        <span class="payment-icon">üíµ</span>
                        <span>Thanh to√°n ti·ªÅn m·∫∑t khi nh·∫≠n h√†ng</span>
                    </label>

                    <label class="payment-option" [class.payment-option--active]="paymentMethod === 'qr'"
                        (click)="paymentMethod = 'qr'">
                        <span class="payment-radio" [class.active]="paymentMethod === 'qr'"></span>
                        <span class="payment-icon">üì±</span>
                        <span>Thanh to√°n b·∫±ng chuy·ªÉn kho·∫£n (QR Code)</span>
                    </label>

                    <label class="payment-option" [class.payment-option--active]="paymentMethod === 'momo'"
                        (click)="paymentMethod = 'momo'">
                        <span class="payment-radio" [class.active]="paymentMethod === 'momo'"></span>
                        <img src="assets/figma/515c49e4ff04f92775dfa684cb71aab58d94394c.png" alt="MoMo"
                            class="payment-logo" />
                        <span>Thanh to√°n b·∫±ng v√≠ MoMo</span>
                    </label>

                    <label class="payment-option" [class.payment-option--active]="paymentMethod === 'zalopay'"
                        (click)="paymentMethod = 'zalopay'">
                        <span class="payment-radio" [class.active]="paymentMethod === 'zalopay'"></span>
                        <span class="payment-icon">üí≥</span>
                        <span>Thanh to√°n b·∫±ng v√≠ ZaloPay</span>
                    </label>

                    <label class="payment-option" [class.payment-option--active]="paymentMethod === 'atm'"
                        (click)="paymentMethod = 'atm'">
                        <span class="payment-radio" [class.active]="paymentMethod === 'atm'"></span>
                        <img src="assets/figma/2fa2c0072b5eed1fbba69aed2773ab02e7354df4.png" alt="ATM"
                            class="payment-logo" />
                        <span>Thanh to√°n b·∫±ng th·∫ª ATM n·ªôi ƒë·ªãa, NAPAS</span>
                    </label>
                </div>
            </div>

            <!-- ===== RIGHT COLUMN: Order Summary ===== -->
            <div class="checkout-right">
                <div class="checkout-summary">
                    <!-- Coupon -->
                    <button class="coupon-btn">
                        <span class="coupon-btn__text">√Åp d·ª•ng ∆∞u ƒë√£i ƒë·ªÉ ƒë∆∞·ª£c gi·∫£m gi√°</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </button>

                    <div class="summary-row">
                        <span class="summary-label">T·ªïng ti·ªÅn</span>
                        <span class="summary-val">{{ formatPrice(originalTotal()) }}</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Gi·∫£m gi√° tr·ª±c ti·∫øp</span>
                        <span class="summary-val summary-val--discount">{{ directDiscountLabel() }}</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Ph√≠ v·∫≠n chuy·ªÉn</span>
                        <span class="summary-val summary-val--free">Mi·ªÖn ph√≠</span>
                    </div>

                    <div class="summary-divider"></div>

                    <div class="summary-row summary-row--total">
                        <span class="summary-label">Th√†nh ti·ªÅn</span>
                        <span class="summary-val summary-val--total">{{ formatPrice(selectedTotal()) }}</span>
                    </div>

                    @if (errorMessage()) {
                    <div class="checkout-submit-error">
                        {{ errorMessage() }}
                    </div>
                    }

                    <button class="btn-submit" (click)="submitOrder()" [disabled]="submitting()">
                        {{ submitting() ? 'ƒêang x·ª≠ l√Ω...' : 'Ho√†n t·∫•t' }}
                    </button>

                    <p class="checkout-terms">
                        B·∫±ng vi·ªác ti·∫øn h√†nh ƒë·∫∑t mua h√†ng, b·∫°n ƒë·ªìng √Ω v·ªõi
                        <a href="#">ƒêi·ªÅu kho·∫£n d·ªãch v·ª•</a> c·ªßa AuraPC
                    </p>
                </div>
            </div>
        </div>

        <!-- ====== ADDRESS SLIDING MODAL ====== -->
        @if (showAddressModal()) {
        <div class="chk-modal-overlay" (click)="closeAddressModal()">
            <div class="chk-modal-container" (click)="$event.stopPropagation()">
                <div class="chk-modal-header">
                    <h3 class="chk-modal-title">
                        {{ addressModalMode() === 'select' ? 'Ch·ªçn ƒë·ªãa ch·ªâ nh·∫≠n h√†ng' : 'Th√™m ƒë·ªãa ch·ªâ m·ªõi' }}
                    </h3>
                    <button class="chk-modal-close" (click)="closeAddressModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                    <!-- Back button for Add mode -->
                    @if (addressModalMode() === 'add') {
                    <button class="chk-modal-back" (click)="switchToSelectMode()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                    </button>
                    }
                </div>

                <div class="chk-modal-body">
                    <div class="chk-modal-slider" [class.show-add]="addressModalMode() === 'add'">
                        <!-- Pane 1: Selection List -->
                        <div class="chk-modal-pane pane-select">
                            <div class="chk-address-list">
                                @for (addr of addressService.addresses(); track addr._id) {
                                <label class="chk-address-item" [class.active]="tempSelectedAddressId === addr._id">
                                    <div class="chk-address-radio">
                                        <input type="radio" name="tempAddr" [value]="addr._id"
                                            [(ngModel)]="tempSelectedAddressId" />
                                        <span class="custom-radio"></span>
                                    </div>
                                    <div class="chk-address-info">
                                        <div class="chk-address-name">{{ addr.fullName }} - {{ addr.phone }}</div>
                                        <div class="chk-address-detail">{{ addr.address }}</div>
                                        <div class="chk-address-ward">{{ addr.ward }}, {{ addr.district }}, {{ addr.city
                                            }}</div>
                                        <div class="chk-address-tags">
                                            <span class="chk-badge">{{ addr.label }}</span>
                                            @if (addr.isDefault) {
                                            <span class="chk-badge chk-badge--default">M·∫∑c ƒë·ªãnh</span>
                                            }
                                        </div>
                                    </div>
                                </label>
                                }
                            </div>
                            <div class="chk-modal-footer">
                                @if (modalError() && addressModalMode() === 'select') {
                                <div class="checkout-submit-error" style="margin-top: 0; margin-bottom: 8px;">
                                    {{ modalError() }}
                                </div>
                                }
                                <button class="btn-chk-confirm" (click)="confirmTempAddress()">X√°c nh·∫≠n</button>
                                <button class="btn-chk-add-new" (click)="switchToAddMode()">Th√™m ƒë·ªãa ch·ªâ m·ªõi</button>
                            </div>
                        </div>

                        <!-- Pane 2: Add Form -->
                        <div class="chk-modal-pane pane-add">
                            <div class="chk-add-form">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">H·ªç t√™n ng∆∞·ªùi nh·∫≠n <span
                                                class="required">*</span></label>
                                        <input type="text" [(ngModel)]="addrFullName" placeholder="H·ªç v√† t√™n" />
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">S·ªë ƒëi·ªán tho·∫°i <span class="required">*</span></label>
                                        <input type="tel" [(ngModel)]="addrPhone" placeholder="S·ªë ƒëi·ªán tho·∫°i" />
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">T·ªânh / Th√†nh ph·ªë <span class="required">*</span></label>
                                    <select [(ngModel)]="addrCity" (change)="onProvinceChange()">
                                        <option value="">Ch·ªçn T·ªânh / Th√†nh ph·ªë</option>
                                        @for (p of addressService.provinces(); track p.code) {
                                        <option [value]="p.name">{{ p.name }}</option>
                                        }
                                    </select>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Qu·∫≠n / Huy·ªán <span class="required">*</span></label>
                                        <select [(ngModel)]="addrDistrict" (change)="onDistrictChange()"
                                            [disabled]="!addrCity">
                                            <option value="">Ch·ªçn Qu·∫≠n / Huy·ªán</option>
                                            @for (d of districts(); track d.code) {
                                            <option [value]="d.name">{{ d.name }}</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Ph∆∞·ªùng / X√£ <span class="required">*</span></label>
                                        <select [(ngModel)]="addrWard" [disabled]="!addrDistrict">
                                            <option value="">Ch·ªçn Ph∆∞·ªùng / X√£</option>
                                            @for (w of wards(); track w.code) {
                                            <option [value]="w.name">{{ w.name }}</option>
                                            }
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">ƒê·ªãa ch·ªâ c·ª• th·ªÉ <span class="required">*</span></label>
                                    <input type="text" [(ngModel)]="addrAddress" placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng..." />
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Lo·∫°i ƒë·ªãa ch·ªâ</label>
                                        <select [(ngModel)]="addrLabel">
                                            <option value="Nh√† ri√™ng">Nh√† ri√™ng</option>
                                            <option value="VƒÉn ph√≤ng">VƒÉn ph√≤ng</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="invoice-row" style="margin-top: 12px; margin-bottom: 0;">
                                    <span class="invoice-label">ƒê·∫∑t l√†m ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" [(ngModel)]="addrIsDefault" />
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                @if (modalError() && addressModalMode() === 'add') {
                                <div class="checkout-submit-error" style="margin-top: 12px; margin-bottom: 0;">
                                    {{ modalError() }}
                                </div>
                                }
                            </div>
                            <div class="chk-modal-footer">
                                <button class="btn-chk-confirm" style="width: 100%;" (click)="saveNewAddress()">Ho√†n
                                    th√†nh</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        }
        }
    </div>
</section>